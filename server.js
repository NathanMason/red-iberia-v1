//////////////////////////////////////////////////////////////////////////
///////// THRIDPARTY PACKAGES
//////////////////////////////////////////////////////////////////////////
const bodyParser = require('body-parser');
const path = require('path');
var cors = require('cors');
var express = require('express');
var log_stdout = process.stdout;
var _ = require('lodash');
const net = require('net')
var websocket = require('nodejs-websocket');

//////////////////////////////////////////////////////////////////////////
///////// SET EXPRESS
//////////////////////////////////////////////////////////////////////////
var app = express();
app.use(cors());


//////////////////////////////////////////////////////////////////////////
///////// TGW Scripts
//////////////////////////////////////////////////////////////////////////
const CONFIG = require(path.join(__dirname, '/server/config.js'));
var config = require('./server/config'); // variables and constants
var gci = require(path.join(__dirname, '/server/gciData.js'));
var dataSender = require(path.join(__dirname, '/server/dataSender.js'));
var dcsSocket = require('./server/dcsSocket.js');
var clientSockets = require('./server/clientSocket.js');

//////////////////////////////////////////////////////////////////////////
///////// SET SOCKET
//////////////////////////////////////////////////////////////////////////
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json({limit:CONFIG.getPostJsonSizeLimit()}));
app.set('view engine', 'ejs');

//////////////////////////////////////////////////////////////////////////
///////// FOLDER STRUCTURE
//////////////////////////////////////////////////////////////////////////
app.use('/', express.static(__dirname + '/app'));
app.use('server', express.static(__dirname + '/server'));
app.use('/node_modules', express.static(__dirname + '/node_modules'));
app.use('/bower_components', express.static(__dirname + '/bower_components'));
app.set('views', __dirname + '/');

//////////////////////////////////////////////////////////////////////////
///////// IMPORT MODULES
//////////////////////////////////////////////////////////////////////////
require('./server/routes.js')(app); //server routes
require('./server/debuger.js'); //server routes


//////////////////////////////////////////////////////////////////////////
///////// DCS CONNECTION
//////////////////////////////////////////////////////////////////////////
dcsSocket(config, _, net)

//////////////////////////////////////////////////////////////////////////
///////// Client CONNECTION
//////////////////////////////////////////////////////////////////////////
clientSockets()


//////////////////////////////////////////////////////////////////////////
///////// Load the function that will send data to each connected client
//////////////////////////////////////////////////////////////////////////
dataSender();


//////////////////////////////////////////////////////////////////////////
///////// LAUNCH THE SERVER
//////////////////////////////////////////////////////////////////////////
app.listen(config.webport);
